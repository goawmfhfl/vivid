import type { Record } from "./types";

/**
 * ì „ì²´ ìš”ì•½ ë¦¬í¬íŠ¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
 * @param isPro Pro ë©¤ë²„ì‹­ ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì§€ì‹œì‚¬í•­ ì°¨ë³„í™”
 */
export function buildSummaryPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  isPro: boolean = false
): string {
  const instruction = isPro
    ? "ì „ì²´ë¥¼ ì¢…í•©í•˜ì—¬ ìƒì„¸í•˜ê³  ê¹Šì´ ìˆëŠ” ìš”ì•½ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. ë” ë§ì€ ì„¸ë¶€ì‚¬í•­ê³¼ ì¸ì‚¬ì´íŠ¸ë¥¼ í¬í•¨í•˜ì„¸ìš”."
    : "ì „ì²´ë¥¼ ì¢…í•©í•˜ì—¬ ê°„ë‹¨í•˜ê²Œ ìš”ì•½ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì•Œë ¤ì£¼ì„¸ìš”.";

  let prompt = `ì•„ë˜ëŠ” ${date} (${dayOfWeek}) í•˜ë£¨ì˜ ëª¨ë“  ê¸°ë¡ì…ë‹ˆë‹¤. ${instruction}\n\n`;

  records.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] [${record.type}] ${record.content}\n`;
  });

  return prompt;
}

/**
 * ì¼ìƒ ê¸°ë¡ ë¦¬í¬íŠ¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
 * @param isPro Pro ë©¤ë²„ì‹­ ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì§€ì‹œì‚¬í•­ ì°¨ë³„í™”
 */
export function buildDailyPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  isPro: boolean = false
): string {
  const dailyRecords = records.filter((r) => r.type === "daily");

  if (dailyRecords.length === 0) {
    return "";
  }

  const instruction = isPro
    ? `ì¼ìƒ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. 
- summary: ì˜¤ëŠ˜ í•˜ë£¨ì˜ ìš”ì•½ì„ 200ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš” (ìƒì„¸í•˜ê²Œ).
- daily_events: ì˜¤ëŠ˜ ìˆì—ˆë˜ êµ¬ì²´ì ì¸ ì¼ë“¤ì„ ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš” (ìµœëŒ€ 15ê°œ).
- keywords: í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì„¸ìš” (ìµœëŒ€ 10ê°œ).
- ai_comment: AI ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.
- emotion_triggers: ê°ì •ì„ ë§Œë“  ì‚¬ê±´Â·ì‚¬ëŒÂ·ìƒí™©ì„ ë‹¤ìŒ 4ê°€ì§€ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”:
  * people: ì§ì¥ë™ë£Œ, ê°€ì¡±, ì—°ì¸, ì¹œêµ¬ ë“± ì‚¬ëŒ ê´€ë ¨
  * work: ë°ë“œë¼ì¸, ë¶ˆì•ˆ, ì¼ì •í­ì£¼ ë“± ì—…ë¬´ ê´€ë ¨
  * environment: ë‚ ì”¨, í”¼ë¡œ, ê¸ˆì „ ë“± í™˜ê²½ ê´€ë ¨
  * self: ê¸°ëŒ€, ë¹„êµ, ìê¸°ë¹„íŒ ë“± ìê¸° ìš”ì¸
- behavioral_clues: ì˜¤ëŠ˜ ê¸°ë¡ ì†ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” í–‰ë™ íŒ¨í„´ì„ ë‹¤ìŒ 5ê°€ì§€ë¡œ ë¶„ë¥˜í•˜ì„¸ìš”:
  * avoidance: íšŒí”¼ í–‰ë™
  * routine_attempt: ë£¨í‹´ ì‹œë„
  * routine_failure: ë£¨í‹´ ì‹¤íŒ¨
  * impulsive: ì¦‰í¥ ì¶©ë™
  * planned: ê³„íšì  í–‰ë™`
    : `ì¼ìƒ ë¦¬í¬íŠ¸ë¥¼ ê°„ë‹¨í•˜ê²Œ ìƒì„±í•˜ì„¸ìš”. 
- summary: ì˜¤ëŠ˜ í•˜ë£¨ì˜ ìš”ì•½ì„ 150ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš” (ê°„ë‹¨í•˜ê²Œ).
- daily_events: ì˜¤ëŠ˜ ìˆì—ˆë˜ êµ¬ì²´ì ì¸ ì¼ë“¤ì„ ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš” (ìµœëŒ€ 10ê°œ).
- keywords: í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì„¸ìš” (ìµœëŒ€ 5ê°œ).
- ai_comment: AI ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.
- emotion_triggers: nullë¡œ ì„¤ì •í•˜ì„¸ìš”.
- behavioral_clues: nullë¡œ ì„¤ì •í•˜ì„¸ìš”.`;

  let prompt = `ì•„ë˜ëŠ” ${date} (${dayOfWeek}) í•˜ë£¨ì˜ ì¼ìƒ ê¸°ë¡ì…ë‹ˆë‹¤. ${instruction}\n\n`;

  dailyRecords.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] ${record.content}\n`;
  });

  return prompt;
}

/**
 * ê°ì • ê¸°ë¡ ë¦¬í¬íŠ¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
 * @param isPro Pro ë©¤ë²„ì‹­ ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì§€ì‹œì‚¬í•­ ì°¨ë³„í™”
 */
export function buildEmotionPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  isPro: boolean = false
): string {
  const emotionRecords = records.filter((r) => r.type === "emotion");

  if (emotionRecords.length === 0) {
    return "";
  }

  const instruction = isPro
    ? "ê°ì • ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. ìƒì„¸í•œ ê°ì • ë¶„ì„ê³¼ ì‹œê°„ëŒ€ë³„ ë³€í™”ë¥¼ ê¹Šì´ ìˆê²Œ ë¶„ì„í•˜ì„¸ìš”."
    : "ê°ì • ë¦¬í¬íŠ¸ë¥¼ ê°„ë‹¨í•˜ê²Œ ìƒì„±í•˜ì„¸ìš”. í•µì‹¬ ê°ì •ë§Œ ê°„ê²°í•˜ê²Œ ì•Œë ¤ì£¼ì„¸ìš”.";

  let prompt = `ì•„ë˜ëŠ” ${date} (${dayOfWeek}) í•˜ë£¨ì˜ ê°ì • ê¸°ë¡ì…ë‹ˆë‹¤. ${instruction}\n\n`;

  emotionRecords.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] ${record.content}\n`;
  });

  // ì‹œê°„ ì •ë³´ ìš”ì•½
  prompt += "\n=== ë ˆì½”ë“œ ìƒì„± ì‹œê°„ ì •ë³´ ===\n";
  prompt +=
    "ìœ„ ì‹œê°„ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ emotion_timelineì„ ìƒì„±í•˜ì„¸ìš”. ê° ë ˆì½”ë“œì˜ created_atì„ í•œêµ­ ì‹œê°„(Asia/Seoul)ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì‹œê°„ëŒ€ë³„ë¡œ ê·¸ë£¹í™”í•˜ê³ , í•´ë‹¹ ì‹œê°„ëŒ€ì˜ ê°ì •ì„ ë¶„ì„í•˜ì„¸ìš”.\n";
  prompt +=
    "ì¤‘ìš”: emotion_timelineì€ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ìƒì„±í•˜ì„¸ìš”. ê°€ì¥ ì¤‘ìš”í•œ ì‹œê°„ëŒ€ì˜ ê°ì • ë³€í™”ë§Œ ì„ ë³„í•˜ì—¬ í¬í•¨í•˜ê³ , ë¹„ìŠ·í•œ ì‹œê°„ëŒ€ì˜ ê°ì •ì€ í†µí•©í•˜ê±°ë‚˜ ê°€ì¥ ëŒ€í‘œì ì¸ ê°ì •ë§Œ ì„ íƒí•˜ì„¸ìš”.\n";

  return prompt;
}

/**
 * VIVID ê¸°ë¡ ë¦¬í¬íŠ¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
 * @param isPro Pro ë©¤ë²„ì‹­ ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì§€ì‹œì‚¬í•­ ì°¨ë³„í™”
 */
export function buildDreamPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  isPro: boolean = false
): string {
  const dreamRecords = records.filter((r) => r.type === "vivid" || r.type === "dream");

  if (dreamRecords.length === 0) {
    return "";
  }

  const instruction = isPro
    ? [
        "VIVID ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.",
        "ì•„ë˜ JSON ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ì±„ì›Œì£¼ì„¸ìš”.",
        "",
        "VIVID ê¸°ë¡ì€ ë‘ ê°€ì§€ ì§ˆë¬¸ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤:",
        "- Q1: ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì–´ë–»ê²Œ ë³´ë‚¼ê¹Œ? (í˜„ì¬ ëª¨ìŠµ)",
        "- Q2: ì•ìœ¼ë¡œì˜ ë‚˜ëŠ” ì–´ë–¤ ëª¨ìŠµì¼ê¹Œ? (ë¯¸ë˜ ë¹„ì „)",
        "",
        "### ğŸ“ ì˜¤ëŠ˜ì˜ VIVID (í˜„ì¬ ëª¨ìŠµ) - Q1 ë¶„ì„",
        "1) current_summary:",
        "- Q1ì— ëŒ€í•œ ë‹µë³€ì„ ë¶„ì„í•˜ì—¬ ì˜¤ëŠ˜ ê¸°ë¡í•œ VIVID ë‚´ìš©ì˜ ìš”ì•½ì„ ì‘ì„±í•©ë‹ˆë‹¤.",
        "- í•˜ë£¨ì˜ í•µì‹¬ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•˜ë˜, ìµœëŒ€ 200ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "",
        "2) current_evaluation:",
        "- Q1ì— ëŒ€í•œ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ì˜¤ëŠ˜ì˜ VIVID ê¸°ë¡ì— ëŒ€í•œ AI í‰ê°€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.",
        "- í˜„ì¬ ìƒíƒœì— ëŒ€í•œ ê°ê´€ì  ë¶„ì„ì„ ë‹´ë°±í•˜ê³  ë”°ëœ»í•œ í†¤ìœ¼ë¡œ ì‘ì„±í•˜ë˜, ìµœëŒ€ 250ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "",
        "3) current_keywords:",
        "- Q1 ë‹µë³€ì—ì„œ ìì£¼ ë“±ì¥í•œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.",
        "- í˜„ì¬ ê´€ì‹¬ì‚¬ì™€ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” í•µì‹¬ ë‹¨ì–´ë“¤ë¡œ 5~8ê°œ ì •ë„ ë½‘ì•„ì£¼ì„¸ìš”.",
        "",
        "### ğŸ¯ ì•ìœ¼ë¡œì˜ ë‚˜ì˜ ëª¨ìŠµ (ë¯¸ë˜ ë¹„ì „) - Q2 ë¶„ì„",
        "4) future_summary:",
        "- Q2ì— ëŒ€í•œ ë‹µë³€ì„ ë¶„ì„í•˜ì—¬ ê¸°ë¡ì—ì„œ ë“œëŸ¬ë‚œ 'ì•ìœ¼ë¡œ ë˜ê³  ì‹¶ì€ ëª¨ìŠµ' ìš”ì•½ì„ ì‘ì„±í•©ë‹ˆë‹¤.",
        "- ë¯¸ë˜ ë¹„ì „ì˜ í•µì‹¬ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•˜ë˜, ìµœëŒ€ 200ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "",
        "5) future_evaluation:",
        "- Q2ì— ëŒ€í•œ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ê·¸ ë¹„ì „ì— ëŒ€í•œ AI í‰ê°€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.",
        "- ë¹„ì „ì˜ ëª…í™•ì„±ê³¼ ì‹¤í˜„ ê°€ëŠ¥ì„±ì„ ë¶„ì„í•˜ë˜, ìµœëŒ€ 250ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "",
        "6) future_keywords:",
        "- Q2 ë‹µë³€ì—ì„œ ìì£¼ ë“±ì¥í•œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.",
        "- ì§€í–¥í•˜ëŠ” ê°€ì¹˜ì™€ ëª©í‘œë¥¼ ë‚˜íƒ€ë‚´ëŠ” í•µì‹¬ ë‹¨ì–´ë“¤ë¡œ 5~8ê°œ ì •ë„ ë½‘ì•„ì£¼ì„¸ìš”.",
        "",
        "### ğŸ“Š ì¼ì¹˜ë„ ë¶„ì„",
        "7) alignment_score:",
        "- ì˜¤ëŠ˜ì˜ ëª¨ìŠµ(Q1) vs ì•ìœ¼ë¡œ ë˜ê³  ì‹¶ì€ ëª¨ìŠµ(Q2)ì˜ ì¼ì¹˜ë„ë¥¼ 0-100ì  ì²™ë„ë¡œ í‰ê°€í•©ë‹ˆë‹¤.",
        "- í˜„ì¬ì™€ ëª©í‘œì˜ ê±°ë¦¬ë¥¼ ì¸¡ì •í•˜ì—¬ ì ìˆ˜ë¥¼ ë¶€ì—¬í•˜ì„¸ìš”.",
        "- ì˜ˆ: 85ì  (ë†’ì€ ì¼ì¹˜ë„), 45ì  (ì¤‘ê°„ ì¼ì¹˜ë„), 20ì  (ë‚®ì€ ì¼ì¹˜ë„)",
        "",
        "### ğŸ” ì‚¬ìš©ì íŠ¹ì„± ë¶„ì„",
        "8) user_characteristics:",
        "- ê¸°ë¡ íŒ¨í„´ê³¼ ë‚´ìš©ì„ ë¶„ì„í•´ ë„ì¶œí•œ ì‚¬ìš©ì íŠ¹ì„±ì„ ìµœëŒ€ 5ê°€ì§€ ì‘ì„±í•©ë‹ˆë‹¤.",
        "- 'ë„ˆëŠ” ì´ëŸ° ì‚¬ëŒì´ë‹¤'ë¼ê³  ë‚™ì¸ì°ì§€ ë§ê³ , ê°€ëŠ¥ì„±ê³¼ ë°©í–¥ì„±ì„ ë³´ì—¬ì£¼ëŠ” ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        '- ì˜ˆ: "ìê¸° ì„±ì°°ì„ ì¤‘ì‹œí•˜ëŠ”", "ë¯¸ë˜ ì§€í–¥ì ì¸", "ê°ì • í‘œí˜„ì´ í’ë¶€í•œ" ë“±',
        "",
        "9) aspired_traits:",
        "- ì˜¤ëŠ˜ì˜ VIVID ê¸°ë¡(Q1, Q2 ëª¨ë‘)ì—ì„œ ë“œëŸ¬ë‚œ ì§€í–¥ ëª¨ìŠµì„ ìµœëŒ€ 5ê°€ì§€ ì‘ì„±í•©ë‹ˆë‹¤.",
        "- ì‚¬ìš©ìê°€ ì¶”êµ¬í•˜ëŠ” ê°€ì¹˜ì™€ ë°©í–¥ì„±ì„ ë‚˜íƒ€ë‚´ëŠ” íŠ¹ì„±ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        '- ì˜ˆ: "ê· í˜• ì¡íŒ ì‚¶ì„ ì¶”êµ¬í•˜ëŠ”", "ì°½ì˜ì ì¸ ë¬¸ì œ í•´ê²°ì", "íƒ€ì¸ê³¼ì˜ ê¹Šì€ ì—°ê²°ì„ ì›í•˜ëŠ”" ë“±',
        "",
        "í†¤ì€ ë‹´ë°±í•˜ê³  ê³¼í•˜ì§€ ì•Šê²Œ, ì‚¬ìš©ìë¥¼ ì¡°ìš©íˆ ì‘ì›í•˜ëŠ” í˜¸ìŠ¤íŠ¸ì²˜ëŸ¼ ì‘ì„±í•˜ì„¸ìš”.",
      ].join("\n")
    : [
        "VIVID ë¦¬í¬íŠ¸ë¥¼ ê°„ë‹¨í•˜ê²Œ ìƒì„±í•˜ì„¸ìš”.",
        "ì•„ë˜ JSON ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ì±„ì›Œì£¼ì„¸ìš”.",
        "",
        "VIVID ê¸°ë¡ì€ ë‘ ê°€ì§€ ì§ˆë¬¸ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤:",
        "- Q1: ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì–´ë–»ê²Œ ë³´ë‚¼ê¹Œ? (í˜„ì¬ ëª¨ìŠµ)",
        "- Q2: ì•ìœ¼ë¡œì˜ ë‚˜ëŠ” ì–´ë–¤ ëª¨ìŠµì¼ê¹Œ? (ë¯¸ë˜ ë¹„ì „)",
        "",
        "1) current_summary: Q1 ë‹µë³€ ìš”ì•½ (150ì ì´ë‚´)",
        "2) current_evaluation: Q1 ë‹µë³€ í‰ê°€ (200ì ì´ë‚´)",
        "3) current_keywords: Q1 ë‹µë³€ í‚¤ì›Œë“œ (3~5ê°œ)",
        "",
        "4) future_summary: Q2 ë‹µë³€ ìš”ì•½ (150ì ì´ë‚´)",
        "5) future_evaluation: Q2 ë‹µë³€ í‰ê°€ (200ì ì´ë‚´)",
        "6) future_keywords: Q2 ë‹µë³€ í‚¤ì›Œë“œ (3~5ê°œ)",
        "",
        "7) alignment_score: Q1ê³¼ Q2ì˜ ì¼ì¹˜ë„ (0-100ì )",
        "",
        "8) user_characteristics: ì‚¬ìš©ì íŠ¹ì„± (ìµœëŒ€ 3ê°œ, ê°„ë‹¨í•˜ê²Œ)",
        "9) aspired_traits: ì§€í–¥í•˜ëŠ” ëª¨ìŠµ (ìµœëŒ€ 3ê°œ, ê°„ë‹¨í•˜ê²Œ)",
      ].join("\n");

  let prompt = `ì•„ë˜ëŠ” ${date} (${dayOfWeek}) í•˜ë£¨ì˜ VIVID ê¸°ë¡ì…ë‹ˆë‹¤.\n${instruction}\n\n`;

  dreamRecords.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] ${record.content}\n`;
  });

  return prompt;
}

/**
 * ì¸ì‚¬ì´íŠ¸ ê¸°ë¡ ë¦¬í¬íŠ¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
 * @param isPro Pro ë©¤ë²„ì‹­ ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì§€ì‹œì‚¬í•­ ì°¨ë³„í™”
 */
export function buildInsightPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  isPro: boolean = false
): string {
  const insightRecords = records.filter((r) => r.type === "insight");

  if (insightRecords.length === 0) {
    return "";
  }

  const instruction = isPro
    ? [
        "ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. ì•„ë˜ ì§€ì¹¨ì„ ë”°ë¼ì£¼ì„¸ìš”:",
        "",
        "1) core_insights:",
        "- ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸ ê¸°ë¡ë“¤ì„ ë¶„ì„í•˜ì—¬ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.",
        "- ê° ì¸ì‚¬ì´íŠ¸ëŠ” í•œ ë¬¸ì¥ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì‘ì„±í•˜ê³ , ìµœëŒ€ 5ê°œ ì´ë‚´ë¡œ ì œí•œí•˜ì„¸ìš”.",
        "- ê° ì¸ì‚¬ì´íŠ¸ë§ˆë‹¤ sourceë¥¼ í•¨ê»˜ ì‘ì„±í•©ë‹ˆë‹¤. ì¶œì²˜ëŠ” êµ¬ì²´ì ìœ¼ë¡œ ëª…ì‹œí•˜ì„¸ìš”.",
        '- ì˜ˆ: { "insight": "ë‚´ ê°ì •ì„ ê¸°ë¡í•  ë•Œë§ˆë‹¤ ë” ëª…í™•í•´ì§„ë‹¤", "source": "ì˜¤ëŠ˜ì˜ ê°ì • ê¸°ë¡" }',
        '- ì˜ˆ: { "insight": "ì™„ë²½í•˜ë ¤ í•˜ì§€ ì•Šì„ ë•Œ ë” ì§€ì†í•  ìˆ˜ ìˆë‹¤", "source": "ì¼ìƒ ê¸°ë¡" }',
        "",
        "2) meta_question:",
        "- ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ë” ë°œì „ì‹œí‚¤ëŠ” ë°©ë²•ì„ ê°„ë‹¨í•˜ê³  ì‹¤ìš©ì ìœ¼ë¡œ ì œì‹œí•©ë‹ˆë‹¤.",
        "- ë„ˆë¬´ ìƒì„¸í•˜ê±°ë‚˜ ì² í•™ì ì´ì§€ ë§ê³ , ë‚´ì¼ ë°”ë¡œ ì‹œë„í•´ë³¼ ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ì§ˆë¬¸ì´ë‚˜ ë°©ë²•ì„ 1~2ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        '- ì˜ˆ: "ì´ ì¸ì‚¬ì´íŠ¸ë¥¼ ë‚´ì¼ í•˜ë£¨ì— ì–´ë–»ê²Œ ì ìš©í•´ë³¼ê¹Œ?"',
        '- ì˜ˆ: "ì´ ê¹¨ë‹¬ìŒì„ ì¼ì£¼ì¼ ë™ì•ˆ ê¸°ë¡í•´ë³´ë©´ ì–´ë–¤ íŒ¨í„´ì´ ë³´ì¼ê¹Œ?"',
        "",
        "3) insight_next_actions:",
        "- ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸ë¥¼ í–‰ë™ìœ¼ë¡œ ì˜®ê¸¸ ìˆ˜ ìˆëŠ” ì•„ì£¼ ì‘ì€ ë‹¤ìŒ í–‰ë™ì„ 1~2ê°œ ì œì•ˆí•˜ì„¸ìš”.",
        "- ê° í•­ëª©ì€ label(í–‰ë™ ë¬¸ì¥), difficulty(ë‚œì´ë„: ë‚®ìŒ/ë³´í†µ/ë†’ìŒ), estimated_minutes(ì˜ˆìƒ ì†Œìš” ì‹œê°„, ë¶„ ë‹¨ìœ„)ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.",
        '- ì˜ˆ: { "label": "ë‚´ì¼ ì•„ì¹¨ 10ë¶„ ë™ì•ˆ ì˜¤ëŠ˜ ë– ì˜¬ëë˜ ìƒê°ì„ í•œ ë²ˆ ë” ì ì–´ë³´ê¸°", "difficulty": "ë‚®ìŒ", "estimated_minutes": 10 }',
        '- ì˜ˆ: { "label": "ë¹„ìŠ·í•œ ìƒí™©ì´ ì˜¬ ë•Œ ë– ì˜¬ë¦¬ê³  ì‹¶ì€ ë¬¸ì¥ì„ í•œ ì¤„ ì •ë¦¬í•´ë‘ê¸°", "difficulty": "ë³´í†µ", "estimated_minutes": 5 }',
        "",
        "4) insight_ai_comment:",
        "- ì¸ì‚¬ì´íŠ¸ì— ëŒ€í•œ AIì˜ ë”°ëœ»í•œ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.",
        "- ì¡°ì–¸ë³´ë‹¤ëŠ” ê³µê°ê³¼ ì‘ì›ì˜ í†¤ìœ¼ë¡œ, ì‚¬ìš©ìê°€ ìì‹ ì˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ì†Œì¤‘íˆ ì—¬ê¸°ë„ë¡ ë„ì™€ì£¼ì„¸ìš”.",
        "",
        "í†¤ì€ ë‹´ë°±í•˜ê³  ê³¼í•˜ì§€ ì•Šê²Œ, ì‚¬ìš©ìë¥¼ ì¡°ìš©íˆ ì‘ì›í•˜ëŠ” í˜¸ìŠ¤íŠ¸ì²˜ëŸ¼ ì‘ì„±í•˜ì„¸ìš”.",
      ].join("\n")
    : [
        "ì¸ì‚¬ì´íŠ¸ ë¦¬í¬íŠ¸ë¥¼ ê°„ë‹¨í•˜ê²Œ ìƒì„±í•˜ì„¸ìš”.",
        "ì•„ë˜ JSON ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ì±„ì›Œì£¼ì„¸ìš”.",
        "",
        "1) core_insightsëŠ” ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ 2~3ê°œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "2) ê° ì¸ì‚¬ì´íŠ¸ëŠ” í•œ ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ê³ , sourceëŠ” ê°„ë‹¨í•˜ê²Œ ëª…ì‹œí•˜ì„¸ìš”.",
        "3) meta_questionì€ Free ìœ ì €ì—ì„œëŠ” nullë¡œ ì„¤ì •í•˜ê±°ë‚˜, ì•„ì£¼ ì§§ì€ 1ë¬¸ì¥ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.",
        "4) insight_next_actionsëŠ” Free ìœ ì €ì—ì„œëŠ” nullë¡œ ì„¤ì •í•˜ì„¸ìš”. (Pro ì „ìš© í•„ë“œì…ë‹ˆë‹¤.)",
        "5) insight_ai_commentëŠ” ì‚¬ìš©ìì˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ê°€ë³ê²Œ ìš”ì•½í•˜ê±°ë‚˜ ì‘ì›í•˜ëŠ” í•œë‘ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
      ].join("\n");

  let prompt = `ì•„ë˜ëŠ” ${date} (${dayOfWeek}) í•˜ë£¨ì˜ ì¸ì‚¬ì´íŠ¸ ê¸°ë¡ì…ë‹ˆë‹¤.\n${instruction}\n\n`;

  insightRecords.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] ${record.content}\n`;
  });

  return prompt;
}

/**
 * í”¼ë“œë°± ê¸°ë¡ ë¦¬í¬íŠ¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
 * @param isPro Pro ë©¤ë²„ì‹­ ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì§€ì‹œì‚¬í•­ ì°¨ë³„í™”
 */
export function buildFeedbackPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  isPro: boolean = false
): string {
  const feedbackRecords = records.filter((r) => r.type === "feedback");

  if (feedbackRecords.length === 0) {
    return "";
  }

  const instruction = isPro
    ? [
        "í”¼ë“œë°± ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. ì•„ë˜ ì§€ì¹¨ì„ ë”°ë¼ì£¼ì„¸ìš”:",
        "",
        "1) core_feedback:",
        "- ì˜¤ëŠ˜ì˜ í”¼ë“œë°± ê¸°ë¡ì„ ì¢…í•©í•˜ì—¬ í•µì‹¬ í”¼ë“œë°±ì„ í•œ ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "",
        "2) positives:",
        "- ì˜í•œ ì ì„ ìµœëŒ€ 6ê°œê¹Œì§€ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "- ê° í•­ëª©ì€ í•œ ë¬¸ì¥ìœ¼ë¡œ, í–‰ë™ì´ë‚˜ íƒœë„ê°€ ëª…í™•í•˜ê²Œ ë“œëŸ¬ë‚˜ë„ë¡ ì‘ì„±í•˜ì„¸ìš”.",
        "",
        "3) improvements:",
        "- ê°œì„ í•  ì ì„ ìµœëŒ€ 6ê°œê¹Œì§€ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "- ê° í•­ëª©ì€ í•œ ë¬¸ì¥ìœ¼ë¡œ, êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë°©í–¥ì„ ì œì‹œí•˜ì„¸ìš”.",
        "",
        "4) ai_message:",
        "- ì‚¬ìš©ìë¥¼ ì‘ì›í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ì„¸ìš”.",
        "- í•˜ë£¨ë¥¼ ë§ˆë¬´ë¦¬í•˜ë©° ì•ìœ¼ë¡œì˜ ì„±ì¥ì„ ê²©ë ¤í•˜ëŠ” ë”°ëœ»í•œ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        "",
        "5) feedback_person_traits:",
        "- ì´ í”¼ë“œë°±ì„ í†µí•´ ì•Œ ìˆ˜ ìˆëŠ” ì‚¬ìš©ìì˜ íŠ¹ì§•ì„ ìµœëŒ€ 5ê°œê¹Œì§€ ì‘ì„±í•˜ì„¸ìš”.",
        "- 'ë„ˆëŠ” ì´ëŸ° ì‚¬ëŒì´ë‹¤'ë¼ê³  ë‚™ì¸ì°ì§€ ë§ê³ , ê°€ëŠ¥ì„±ê³¼ ë°©í–¥ì„±ì„ ë³´ì—¬ì£¼ëŠ” ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.",
        '- ì˜ˆ: "ìê¸° ìì‹ ì„ ê°ê´€ì ìœ¼ë¡œ ë°”ë¼ë³´ë ¤ëŠ” ì‚¬ëŒ", "ì„±ì¥ì„ ìœ„í•´ ì†”ì§í•˜ê²Œ ê¸°ë¡í•˜ëŠ” ì‚¬ëŒ"',
        "",
        "í†¤ì€ ë‹´ë°±í•˜ê³  ê³¼í•˜ì§€ ì•Šê²Œ, ì‚¬ìš©ìë¥¼ ì¡°ìš©íˆ ì‘ì›í•˜ëŠ” í˜¸ìŠ¤íŠ¸ì²˜ëŸ¼ ì‘ì„±í•˜ì„¸ìš”.",
      ].join("\n")
    : [
        "í”¼ë“œë°± ë¦¬í¬íŠ¸ë¥¼ ê°„ë‹¨í•˜ê²Œ ìƒì„±í•˜ì„¸ìš”.",
        "ì•„ë˜ JSON ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ì±„ì›Œì£¼ì„¸ìš”.",
        "",
        "1) core_feedbackì€ ì˜¤ëŠ˜ì˜ í”¼ë“œë°± ê¸°ë¡ì„ í•œ ë¬¸ë‹¨ìœ¼ë¡œ ìš”ì•½í•˜ì„¸ìš”.",
        "2) positivesëŠ” ì˜í•œ ì ì„ 2~3ê°œ ì •ë„ë§Œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.",
        "3) improvementsëŠ” ê°œì„ í•  ì ì„ 2~3ê°œ ì •ë„ë§Œ ê°„ê²°í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”. (Pro ì „ìš©: ìµœëŒ€ 6ê°œ)",
        "4) ai_messageëŠ” Free ìœ ì €ì—ì„œëŠ” nullë¡œ ì„¤ì •í•˜ì„¸ìš”. (Pro ì „ìš© í•„ë“œì…ë‹ˆë‹¤.)",
        "5) feedback_person_traitsëŠ” Free ìœ ì €ì—ì„œëŠ” nullë¡œ ì„¤ì •í•˜ì„¸ìš”. (Pro ì „ìš© í•„ë“œì…ë‹ˆë‹¤.)",
      ].join("\n");

  let prompt = `ì•„ë˜ëŠ” ${date} (${dayOfWeek}) í•˜ë£¨ì˜ í”¼ë“œë°± ê¸°ë¡ì…ë‹ˆë‹¤.\n${instruction}\n\n`;

  feedbackRecords.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] ${record.content}\n`;
  });

  return prompt;
}

/**
 * ìµœì¢… ë¦¬í¬íŠ¸ í”„ë¡¬í”„íŠ¸ ìƒì„± (ëª¨ë“  ë¦¬í¬íŠ¸ë¥¼ ì¢…í•©)
 * @param isPro Pro ë©¤ë²„ì‹­ ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì§€ì‹œì‚¬í•­ ì°¨ë³„í™”
 */
/**
 * ìµœì¢… ë¦¬í¬íŠ¸ í”„ë¡¬í”„íŠ¸ ìƒì„± (records ê¸°ë°˜)
 * @param isPro Pro ë©¤ë²„ì‹­ ì—¬ë¶€ì— ë”°ë¼ í”„ë¡¬í”„íŠ¸ ì§€ì‹œì‚¬í•­ ì°¨ë³„í™”
 */
export function buildFinalPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  isPro: boolean = false
): string {
  const instruction = isPro
    ? "í•˜ë£¨ì˜ ëª¨ë“  ê¸°ë¡ì„ ì¢…í•©í•˜ì—¬ ìƒì„¸í•˜ê³  ê¹Šì´ ìˆëŠ” ìµœì¢… ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. ë” ë§ì€ ì¸ì‚¬ì´íŠ¸ì™€ ì¡°ì–¸ì„ í¬í•¨í•˜ì„¸ìš”."
    : "í•˜ë£¨ì˜ ëª¨ë“  ê¸°ë¡ì„ ì¢…í•©í•˜ì—¬ ê°„ë‹¨í•œ ìµœì¢… ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì•Œë ¤ì£¼ì„¸ìš”.";

  let prompt = `ì•„ë˜ëŠ” ${date} (${dayOfWeek}) í•˜ë£¨ì˜ ëª¨ë“  ê¸°ë¡ì…ë‹ˆë‹¤. ${instruction}\n\n`;

  records.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] [${record.type}] ${record.content}\n`;
  });

  prompt +=
    "\nìœ„ ëª¨ë“  ê¸°ë¡ì„ ì¢…í•©í•˜ì—¬ í•˜ë£¨ë¥¼ ì •ë¦¬í•˜ëŠ” ë§ˆë¬´ë¦¬ ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.";

  return prompt;
}
