import type { Record } from "./types";


export function buildReportPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  _isPro: boolean = false,
  userName?: string,
  personaContext?: string,
  todoCheckInfo?: { checked: number; total: number },
  hasIdealSelfInPersona?: boolean
): string {
  const targetRecords = records.filter(
    (r) =>
      r.type === "vivid" || r.type === "dream" || r.type === "review"
  );

  if (targetRecords.length === 0) {
    return "";
  }

  const personaBlock =
    personaContext && personaContext.trim()
      ? personaContext.trim() +
        "\n\n[íŽ˜ë¥´ì†Œë‚˜ ë°˜ì˜ ì§€ì¹¨]\n" +
        "- current_evaluation, future_evaluation ì¤‘ ì ì–´ë„ 1~2ê³³ì—ì„œ, ì´ ì‚¬ìš©ìžì˜ íŽ˜ë¥´ì†Œë‚˜(íŠ¹ì„±Â·ì§€í–¥Â·íŒ¨í„´)ì™€ ì˜¤ëŠ˜ ê¸°ë¡ì„ ì—°ê²°í•˜ëŠ” ë¬¸ìž¥ì„ ìžì—°ìŠ¤ëŸ½ê²Œ ë„£ì–´ì£¼ì„¸ìš”.\n" +
        "- ì˜ˆ: 'í‰ì†Œ ëª°ìž…ì„ ì¶”êµ¬í•˜ëŠ” ì„±í–¥ì´ ì˜¤ëŠ˜ì˜ ê¸°ë¡ì—ì„œë„ ë“œëŸ¬ë‚œë‹¤', 'ì§€í–¥í•˜ëŠ” ìžì•„ì™€ ì˜¤ëŠ˜ì˜ ë¹„ì „ì´ ìž˜ ë§žë‹¿ì•„ ìžˆë‹¤' ë“±. ê³¼í•˜ì§€ ì•Šê²Œ, 1ë¬¸ìž¥ ì •ë„ë¡œ.\n" +
        "- user_characteristicsë‚˜ aspired_traitsì— íŽ˜ë¥´ì†Œë‚˜ì™€ ì¼ì¹˜í•˜ëŠ” íŠ¹ì„±ì´ ìžˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜ì˜í•˜ì„¸ìš”.\n\n"
      : "";

  const honorificRule =
    userName && userName !== "íšŒì›"
      ? `ì‘ë‹µ ë¬¸ìž¥ì—ì„œ ì‚¬ìš©ìžë¥¼ ì§€ì¹­í•  ë•ŒëŠ” ë°˜ë“œì‹œ '${userName}ë‹˜'ìœ¼ë¡œ í˜¸ì¹­í•˜ê³ , 'ë‹¹ì‹ 'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. (ì˜ˆ: ë³¸ëª…ì´ 'ìµœìž¬ì˜'ì´ë©´ 'ìž¬ì˜ë‹˜'ìœ¼ë¡œ í˜¸ì¹­)\n\n`
      : "ì‘ë‹µ ë¬¸ìž¥ì—ì„œ 'ë‹¹ì‹ 'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. ì‚¬ìš©ìžë¥¼ ì§€ì¹­í•  ë•ŒëŠ” 'íšŒì›ë‹˜' ë“±ìœ¼ë¡œ í˜¸ì¹­í•˜ì„¸ìš”.\n\n";

  // Pro/Free ë™ì¼í•œ ìƒì„¸ í”„ë¡¬í”„íŠ¸ ì‚¬ìš© (FreeëŠ” Flash ëª¨ë¸ë¡œ ë¹„ìš© ì ˆê°)
  const instruction = [
    "VIVID ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.",
    "ì•„ëž˜ JSON ìŠ¤í‚¤ë§ˆì— ë§žê²Œ ì±„ì›Œì£¼ì„¸ìš”.",
    "",
    "VIVID ê¸°ë¡ì€ ì„¸ ê°€ì§€ ì§ˆë¬¸ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìžˆìŠµë‹ˆë‹¤:",
    "- Q1: ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì–´ë–»ê²Œ ë³´ë‚¼ê¹Œ? (í˜„ìž¬ ëª¨ìŠµ)",
    "- Q2: ì•žìœ¼ë¡œì˜ ë‚˜ëŠ” ì–´ë–¤ ëª¨ìŠµì¼ê¹Œ? (ë¯¸ëž˜ ë¹„ì „)",
    "- Q3: ì˜¤ëŠ˜ì˜ ë‚˜ëŠ” ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ëƒˆì„ê¹Œ? (íšŒê³ /ì‹¤í–‰)",
    "",
    "### ðŸ“ ì˜¤ëŠ˜ì˜ VIVID (í˜„ìž¬ ëª¨ìŠµ) - Q1 ë¶„ì„",
    "1) current_summary:",
    "- Q1ì— ëŒ€í•œ ë‹µë³€ì„ ë¶„ì„í•˜ì—¬ ì˜¤ëŠ˜ ê¸°ë¡í•œ VIVID ë‚´ìš©ì˜ ìš”ì•½ì„ ìž‘ì„±í•©ë‹ˆë‹¤.",
    "- í•˜ë£¨ì˜ í•µì‹¬ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•˜ë˜, êµ¬ì²´ì ì¸ ì¸ì‚¬ì´íŠ¸ì™€ ë§¥ë½ì„ í¬í•¨í•˜ì—¬ ìµœëŒ€ 400ìž ì´ë‚´ë¡œ ìž‘ì„±í•˜ì„¸ìš”.",
    "",
    "2) current_evaluation:",
    "- Q1ì— ëŒ€í•œ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ì˜¤ëŠ˜ì˜ VIVID ê¸°ë¡ì— ëŒ€í•œ AI í‰ê°€ë¥¼ ìž‘ì„±í•©ë‹ˆë‹¤.",
    "- í˜„ìž¬ ìƒíƒœì— ëŒ€í•œ ê°ê´€ì  ë¶„ì„ì„ ë‹´ë°±í•˜ê³  ë”°ëœ»í•œ í†¤ìœ¼ë¡œ ìž‘ì„±í•˜ë˜, ìµœëŒ€ 250ìž ì´ë‚´ë¡œ ìž‘ì„±í•˜ì„¸ìš”.",
    "- [íŽ˜ë¥´ì†Œë‚˜ê°€ ì œê³µëœ ê²½ìš°] ì´ ì‚¬ìš©ìžì˜ ì•Œë ¤ì§„ ì„±í–¥Â·íŒ¨í„´ê³¼ ì˜¤ëŠ˜ ê¸°ë¡ì„ ì—°ê²°í•˜ëŠ” ë¬¸ìž¥ì„ 1ê°œ ì •ë„ ìžì—°ìŠ¤ëŸ½ê²Œ ë„£ì–´ 'ë„ˆì˜ ì„±í–¥ì„ ê¸°ì–µí•˜ê³  ìžˆë‹¤'ëŠ” ì¸ìƒì„ ì£¼ì„¸ìš”. ê³¼í•˜ì§€ ì•Šê²Œ.",
    "",
    "3) current_keywords:",
    "- Q1 ë‹µë³€ì—ì„œ ìžì£¼ ë“±ìž¥í•œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.",
    "- í˜„ìž¬ ê´€ì‹¬ì‚¬ì™€ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” í•µì‹¬ ë‹¨ì–´ë“¤ë¡œ 5~8ê°œ ì •ë„ ë½‘ì•„ì£¼ì„¸ìš”.",
    "",
    "### ðŸŽ¯ ì•žìœ¼ë¡œì˜ ë‚˜ì˜ ëª¨ìŠµ (ë¯¸ëž˜ ë¹„ì „) - Q2 ë¶„ì„",
    "4) future_summary:",
    "- Q2ì— ëŒ€í•œ ë‹µë³€ì„ ë¶„ì„í•˜ì—¬ ê¸°ë¡ì—ì„œ ë“œëŸ¬ë‚œ 'ì•žìœ¼ë¡œ ë˜ê³  ì‹¶ì€ ëª¨ìŠµ' ìš”ì•½ì„ ìž‘ì„±í•©ë‹ˆë‹¤.",
    "- ë¯¸ëž˜ ë¹„ì „ì˜ í•µì‹¬ ë‚´ìš©ì„ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•˜ë˜, êµ¬ì²´ì ì¸ ì¸ì‚¬ì´íŠ¸ì™€ ë§¥ë½ì„ í¬í•¨í•˜ì—¬ ìµœëŒ€ 400ìž ì´ë‚´ë¡œ ìž‘ì„±í•˜ì„¸ìš”.",
    "",
    "5) future_evaluation:",
    "- Q2ì— ëŒ€í•œ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ê·¸ ë¹„ì „ì— ëŒ€í•œ AI í‰ê°€ë¥¼ ìž‘ì„±í•©ë‹ˆë‹¤.",
    "- ë¹„ì „ì˜ ëª…í™•ì„±ê³¼ ì‹¤í˜„ ê°€ëŠ¥ì„±ì„ ë¶„ì„í•˜ë˜, ìµœëŒ€ 250ìž ì´ë‚´ë¡œ ìž‘ì„±í•˜ì„¸ìš”.",
    "- [íŽ˜ë¥´ì†Œë‚˜ê°€ ì œê³µëœ ê²½ìš°] ì‚¬ìš©ìžì˜ ì§€í–¥í•˜ëŠ” ìžì•„Â·ì›ë™ë ¥ê³¼ ì˜¤ëŠ˜ ë¹„ì „ì˜ ì—°ê²°ì„ 1ë¬¸ìž¥ ì •ë„ë¡œ ìžì—°ìŠ¤ëŸ½ê²Œ ì–¸ê¸‰í•˜ì„¸ìš”.",
    "",
    "6) future_keywords:",
    "- Q2 ë‹µë³€ì—ì„œ ìžì£¼ ë“±ìž¥í•œ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.",
    "- ì§€í–¥í•˜ëŠ” ê°€ì¹˜ì™€ ëª©í‘œë¥¼ ë‚˜íƒ€ë‚´ëŠ” í•µì‹¬ ë‹¨ì–´ë“¤ë¡œ 5~8ê°œ ì •ë„ ë½‘ì•„ì£¼ì„¸ìš”.",
    "",
    "### ðŸ“Š ì¼ì¹˜ë„ ë¶„ì„",
    hasIdealSelfInPersona
      ? "- [íŽ˜ë¥´ì†Œë‚˜ì˜ ì§€í–¥í•˜ëŠ” ìžì•„(ideal_self) ê¸°ë°˜] Q1(ì˜¤ëŠ˜ì˜ ê³„íš)ê³¼ íŽ˜ë¥´ì†Œë‚˜ì— ê¸°ë¡ëœ 'ì§€í–¥í•˜ëŠ” ìžì•„'ë¥¼ ë¹„êµí•˜ì—¬ ì¼ì¹˜ë„ë¥¼ ì‚°ì •í•©ë‹ˆë‹¤. Q2ëŠ” ë³´ì¡° ì°¸ê³ ë§Œ í•˜ì„¸ìš”."
      : "- [Q2 ê¸°ë°˜] Q1(ì˜¤ëŠ˜ì˜ ê³„íš)ê³¼ Q2(ë¯¸ëž˜ ë¹„ì „)ì˜ ë‚´ìš©ì„ ë¹„êµí•˜ì—¬ ì¼ì¹˜ë„ë¥¼ ì‚°ì •í•©ë‹ˆë‹¤.",
    "",
    "7) alignment_score:",
    hasIdealSelfInPersona
      ? "- Q1ê³¼ íŽ˜ë¥´ì†Œë‚˜ì˜ 'ì§€í–¥í•˜ëŠ” ìžì•„'ê°€ ì–¼ë§ˆë‚˜ ì •ë ¬ë˜ì–´ ìžˆëŠ”ì§€ 0-100ì ìœ¼ë¡œ ì‚°ì •í•©ë‹ˆë‹¤."
      : "- Q1ê³¼ Q2ì˜ ë‚´ìš©ì´ ì–¼ë§ˆë‚˜ ìœ ì‚¬í•œì§€ ë‹¨ìˆœ ë¹„êµí•´ 0-100ì ìœ¼ë¡œ ì‚°ì •í•©ë‹ˆë‹¤.",
    "- ê¸°ì¤€: í•µì‹¬ í‚¤ì›Œë“œ/ì£¼ì œì˜ ê²¹ì¹¨ ì •ë„ë§Œ ë°˜ì˜í•˜ì„¸ìš”",
    "- ë†’ì€ ì ìˆ˜(80ì  ì´ìƒ): ì˜¤ëŠ˜ì˜ ê³„íšì´ ì§€í–¥í•˜ëŠ” ëª¨ìŠµê³¼ ìž˜ ì •ë ¬ë¨",
    "- ì¤‘ê°„ ì ìˆ˜(50-79ì ): ì¼ë¶€ë§Œ ì •ë ¬ë¨",
    "- ë‚®ì€ ì ìˆ˜(50ì  ë¯¸ë§Œ): ê±°ì˜ ì •ë ¬ë˜ì§€ ì•ŠìŒ",
    "- ê³¼ë„í•œ í•´ì„ ì—†ì´ ìœ ì‚¬ì„±ë§Œ íŒë‹¨í•˜ì„¸ìš”",
    "- ê²°ê³¼ëŠ” ê°€ëŠ¥í•œ í•œ ë¹ ë¥´ê²Œ ì‚°ì¶œí•˜ì„¸ìš”",
    "",
    "8) alignment_analysis_points:",
    hasIdealSelfInPersona
      ? "- Q1ê³¼ íŽ˜ë¥´ì†Œë‚˜ì˜ ì§€í–¥í•˜ëŠ” ìžì•„ ì‚¬ì´ì—ì„œ í•µì‹¬ì ìœ¼ë¡œ ê²¹ì¹˜ëŠ” í‚¤ì›Œë“œë‚˜ ì£¼ì œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤."
      : "- Q1ê³¼ Q2 ì‚¬ì´ì—ì„œ í•µì‹¬ì ìœ¼ë¡œ ê²¹ì¹˜ëŠ” í‚¤ì›Œë“œë‚˜ ì£¼ì œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.",
    "- ì ìˆ˜ ì‚°ì •ì˜ í•µì‹¬ ê·¼ê±°ë¥¼ 1~3ê°œì˜ ì§§ì€ ë¬¸ìž¥ì´ë‚˜ í‚¤ì›Œë“œë¡œ ë¦¬ìŠ¤íŠ¸ì—…í•©ë‹ˆë‹¤.",
    '- ì˜ˆì‹œ: ["\'ì„±ìž¥\'ì´ë¼ëŠ” ê³µí†µ í‚¤ì›Œë“œ", "ì•„ì¹¨ ìš´ë™ì— ëŒ€í•œ ì˜ì§€ê°€ ì¼ì¹˜í•¨", "ìƒˆë¡œìš´ ë„ì „ì— ëŒ€í•œ ê¸ì •ì  íƒœë„"]',
    "- ê²¹ì¹˜ëŠ” ì£¼ì œê°€ ì ìœ¼ë©´ \"ê³µí†µ ì£¼ì œê°€ ê±°ì˜ ì—†ìŒ\"ê³¼ ê°™ì´ ëª…ì‹œí•˜ì„¸ìš”.",
    "",
    "9) alignment_based_on_persona:",
    hasIdealSelfInPersona
      ? "- ë°˜ë“œì‹œ trueë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. (íŽ˜ë¥´ì†Œë‚˜ì˜ ì§€í–¥í•˜ëŠ” ìžì•„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‚°ì •í–ˆìœ¼ë¯€ë¡œ)"
      : "- ë°˜ë“œì‹œ falseë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. (Q2ë§Œ ê¸°ì¤€ìœ¼ë¡œ ì‚°ì •í–ˆìœ¼ë¯€ë¡œ)",
    "",
    "### ðŸ” ì‚¬ìš©ìž íŠ¹ì„± ë¶„ì„",
    "10) user_characteristics:",
    "- ê¸°ë¡ íŒ¨í„´ê³¼ ë‚´ìš©ì„ ë¶„ì„í•´ ë„ì¶œí•œ ì‚¬ìš©ìž íŠ¹ì„±ì„ ìµœëŒ€ 5ê°€ì§€ ìž‘ì„±í•©ë‹ˆë‹¤.",
    "- [íŽ˜ë¥´ì†Œë‚˜ê°€ ì œê³µëœ ê²½ìš°] íŽ˜ë¥´ì†Œë‚˜ì˜ íŠ¹ì„±Â·ì§€í–¥ê³¼ ì˜¤ëŠ˜ ê¸°ë¡ì´ ë§žëŠ” ë¶€ë¶„ì„ ìš°ì„  ë°˜ì˜í•˜ì„¸ìš”. 'ì´ì „ì— íŒŒì•…í•œ ë„ˆì˜ ëª¨ìŠµ'ê³¼ ì¼ê´€ë˜ê²Œ.",
    "- 'ë„ˆëŠ” ì´ëŸ° ì‚¬ëžŒì´ë‹¤'ë¼ê³  ë‚™ì¸ì°ì§€ ë§ê³ , ê°€ëŠ¥ì„±ê³¼ ë°©í–¥ì„±ì„ ë³´ì—¬ì£¼ëŠ” ë¬¸ìž¥ìœ¼ë¡œ ìž‘ì„±í•˜ì„¸ìš”.",
    '- ì˜ˆ: "ìžê¸° ì„±ì°°ì„ ì¤‘ì‹œí•˜ëŠ”", "ë¯¸ëž˜ ì§€í–¥ì ì¸", "ê°ì • í‘œí˜„ì´ í’ë¶€í•œ" ë“±',
    "",
    "11) aspired_traits:",
    "- ì˜¤ëŠ˜ì˜ VIVID ê¸°ë¡(Q1, Q2 ëª¨ë‘)ì—ì„œ ë“œëŸ¬ë‚œ ì§€í–¥ ëª¨ìŠµì„ ìµœëŒ€ 5ê°€ì§€ ìž‘ì„±í•©ë‹ˆë‹¤.",
    "- [íŽ˜ë¥´ì†Œë‚˜ê°€ ì œê³µëœ ê²½ìš°] íŽ˜ë¥´ì†Œë‚˜ì˜ ì§€í–¥í•˜ëŠ” ìžì•„Â·ì›ë™ë ¥ê³¼ ì˜¤ëŠ˜ ê¸°ë¡ì—ì„œ ë“œëŸ¬ë‚œ ì§€í–¥ì´ ê²¹ì¹˜ëŠ” ë¶€ë¶„ì„ ë°˜ì˜í•˜ì„¸ìš”.",
    "- ì‚¬ìš©ìžê°€ ì¶”êµ¬í•˜ëŠ” ê°€ì¹˜ì™€ ë°©í–¥ì„±ì„ ë‚˜íƒ€ë‚´ëŠ” íŠ¹ì„±ìœ¼ë¡œ ìž‘ì„±í•˜ì„¸ìš”.",
    '- ì˜ˆ: "ê· í˜• ìž¡ížŒ ì‚¶ì„ ì¶”êµ¬í•˜ëŠ”", "ì°½ì˜ì ì¸ ë¬¸ì œ í•´ê²°ìž", "íƒ€ì¸ê³¼ì˜ ê¹Šì€ ì—°ê²°ì„ ì›í•˜ëŠ”" ë“±',
    "",
    "í†¤ì€ ë‹´ë°±í•˜ê³  ê³¼í•˜ì§€ ì•Šê²Œ, ì‚¬ìš©ìžë¥¼ ì¡°ìš©ížˆ ì‘ì›í•˜ëŠ” í˜¸ìŠ¤íŠ¸ì²˜ëŸ¼ ìž‘ì„±í•˜ì„¸ìš”.",
    "",
    honorificRule.trim(),
  ].join("\n");

  let prompt =
    personaBlock +
    `ì•„ëž˜ëŠ” ${date} (${dayOfWeek}) í•˜ë£¨ì˜ VIVID ê¸°ë¡ìž…ë‹ˆë‹¤.\n${instruction}\n\n`;

  targetRecords.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] ${record.content}\n`;
  });

  return prompt;
}

/** íšŒê³  ì „ìš© í”„ë¡¬í”„íŠ¸ (Q3 + íˆ¬ë‘ + user_persona "ë‚˜ì˜ íŠ¹ì§•" ê¸°ë°˜) */
export function buildReviewReportPrompt(
  records: Record[],
  date: string,
  dayOfWeek: string,
  todoItems: { contents: string; is_checked: boolean }[],
  personaTraitsBlock: string,
  userName?: string
): string {
  const q3Records = records.filter((r) =>
    /Q3\.\s*ì˜¤ëŠ˜ì˜ ë‚˜ëŠ” ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ëƒˆì„ê¹Œ\?/i.test(r.content || "")
  );
  if (q3Records.length === 0) return "";

  const honorificRule =
    userName && userName !== "íšŒì›"
      ? `ì‘ë‹µ ë¬¸ìž¥ì—ì„œ ì‚¬ìš©ìžë¥¼ ì§€ì¹­í•  ë•ŒëŠ” ë°˜ë“œì‹œ '${userName}ë‹˜'ìœ¼ë¡œ í˜¸ì¹­í•˜ê³ , 'ë‹¹ì‹ 'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.\n\n`
      : "ì‘ë‹µ ë¬¸ìž¥ì—ì„œ 'ë‹¹ì‹ 'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. 'íšŒì›ë‹˜' ë“±ìœ¼ë¡œ í˜¸ì¹­í•˜ì„¸ìš”.\n\n";

  const completedTodos = todoItems.filter((t) => t.is_checked).map((t) => t.contents);
  const uncompletedTodos = todoItems.filter((t) => !t.is_checked).map((t) => t.contents);

  const instruction = [
    "íšŒê³  ì „ìš© ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”. ì•„ëž˜ JSON ìŠ¤í‚¤ë§ˆì— ë§žê²Œ ì±„ì›Œì£¼ì„¸ìš”.",
    "",
    "Q3(ì˜¤ëŠ˜ì˜ ë‚˜ëŠ” ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ëƒˆì„ê¹Œ?)ë§Œì„ ë¶„ì„í•©ë‹ˆë‹¤. Q1, Q2ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
    "",
    "1) retrospective_summary: Q3 ìš”ì•½. ì˜¤ëŠ˜ì˜ ì‹¤í–‰/ê²½í—˜ì„ ê°„ê²°í•˜ê²Œ ì •ë¦¬.",
    "2) retrospective_evaluation: Q3 í‰ê°€. ë‹´ë°±í•˜ê³  ë”°ëœ»í•œ í†¤ìœ¼ë¡œ í”¼ë“œë°±.",
    "3) execution_score: íˆ¬ë‘ ì²´í¬ ì™„ë£Œìœ¨ì„ ë°˜ì˜í•œ ì‹¤í–‰ë ¥ ì ìˆ˜ (0-100).",
    "4) execution_analysis_points: ì‹¤í–‰ë ¥ ì ìˆ˜ ê·¼ê±° 1~3ê°œ.",
    "5) completed_todos: ì™„ë£Œí•œ í•  ì¼ ëª©ë¡ (ì‚¬ìš©ìž ìž…ë ¥ ê·¸ëŒ€ë¡œ ë˜ëŠ” ìš”ì•½).",
    "6) uncompleted_todos: ë¯¸ì™„ë£Œ í•  ì¼ ëª©ë¡.",
    "7) todo_feedback: user_persona 'ë‚˜ì˜ íŠ¹ì§•' ê¸°ë°˜ìœ¼ë¡œ ê° íˆ¬ë‘ì— ëŒ€í•œ í”¼ë“œë°± 1~3ê°œ.",
    "8) daily_summary: ì˜¤ëŠ˜ í•œ ì¼ ê°„ë‹¨ ìš”ì•½.",
    "9) suggested_todos_for_tomorrow: { reason: string, items: string[] } - ë‚´ì¼ì„ ìœ„í•œ í•  ì¼ ì œì•ˆ. reasonì— ê¶Œìž¥ ì´ìœ (1~2ë¬¸ìž¥), itemsì— êµ¬ì²´ì  í•  ì¼ 2~4ê°œ. ì˜¤ëŠ˜ íšŒê³ ì™€ ë¯¸ì™„ë£Œ/í”¼ë“œë°±ì„ ë°”íƒ•ìœ¼ë¡œ ë‚´ì¼ í•˜ë©´ ì¢‹ì„ ì¼ì„ ì œì•ˆ.",
    "",
    "í†¤ì€ ë‹´ë°±í•˜ê³  ê³¼í•˜ì§€ ì•Šê²Œ, ì‚¬ìš©ìžë¥¼ ì¡°ìš©ížˆ ì‘ì›í•˜ëŠ” í˜¸ìŠ¤íŠ¸ì²˜ëŸ¼ ìž‘ì„±í•˜ì„¸ìš”.",
    "",
    honorificRule.trim(),
  ].join("\n");

  let prompt = "";
  if (personaTraitsBlock.trim()) {
    prompt += `[ì‚¬ìš©ìž íŽ˜ë¥´ì†Œë‚˜ - ë‚˜ì˜ íŠ¹ì§•]\n${personaTraitsBlock}\n\n`;
  }
  prompt += `[íˆ¬ë‘ í˜„í™©]\nì™„ë£Œ: ${completedTodos.join(" / ") || "(ì—†ìŒ)"}\në¯¸ì™„ë£Œ: ${uncompletedTodos.join(" / ") || "(ì—†ìŒ)"}\n\n`;
  prompt += `ì•„ëž˜ëŠ” ${date} (${dayOfWeek}) íšŒê³  ê¸°ë¡ìž…ë‹ˆë‹¤.\n${instruction}\n\n`;

  q3Records.forEach((record, idx) => {
    const createdAt = new Date(record.created_at);
    const kstTime = createdAt.toLocaleTimeString("ko-KR", {
      hour: "2-digit",
      minute: "2-digit",
      timeZone: "Asia/Seoul",
    });
    prompt += `${idx + 1}. [${kstTime}] ${record.content}\n`;
  });

  return prompt;
}
